<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Образец формы</title>
    <link rel="stylesheet" href="css/modal-style.css">
</head>
<body>
    <script src="vue-dev/dist/vue.js"></script>
    
    <div id="modal-auth" v-show="showModal">
        <div class="modal-mask">
            <div class="modal-wrapper">
                <div class="table">
                    <div class="row">
                        Введите имя пользователя:
                    </div>
                    <div class="row">
                        <input type="text" name="username" placeholder="Введите имя пользователя">
                    </div>
                    <div class="row">
                        Введите пароль:
                    </div>
                    <div class="row">
                        <input type="password" name="password" placeholder="Введите пароль">
                    </div>
                    <div class="row">
                        <input type="submit" value="Войти" @click="compareHashesHTTP">
                    </div>

                </div>
            </div>
        </div>
    </div>
    
    <script src="lib/sjcl/sjcl.js"></script>
    
    <script>
        new Vue({
            el: '#modal-auth',
            data: {
                showModal: true,
                userHash: "",
                blobArray: new Blob(["d29af8a2e160dd867fe45a75f70bf805b1b6c1cf92017cf53cdf1d5cf390c916"], {type: 'text/plain'})
            },
            methods: {
                compareHashes: function() {
                    if (this.isEmptyPassword()) {
                        this.userHash = "" + sjcl.codec.hex.fromBits(sjcl.hash.sha256.hash("" + document.querySelector('input[type="password"]').value))
                    } else {
                        alert('Строка пустая')
                        return
                    }
                    
                    let textPromise = this.blobArray.text()

                    textPromise.then(text => {
                        if (this.userHash == text) {
                            alert('Все работает')
                            this.showModal = false
                        }
                    });
                },
                isEmptyPassword: function() {
                    if (document.querySelector('input[type="password"]').value != "") {
                        return true
                    } else {
                        return false
                    }
                },
                compareHashesHTTP: function() {
                    if (this.isEmptyPassword()) {
                        this.userHash = "" + sjcl.codec.hex.fromBits(sjcl.hash.sha256.hash("" + document.querySelector('input[type="password"]').value))
                    } else {
                        alert('Строка пустая')
                        return
                    } 

                    let xhr = new XMLHttpRequest()

                    xhr.open('GET', '/var/passwd', false)

                    xhr.send()

                    if (xhr.status != 200) {
                        alert (xhr.status + ": " + xhr.statusText)
                    } else if (xhr.responseText == this.userHash) {
                        alert('Добро пожаловать!')
                        this.showModal = false
                    } else {
                        alert('Не удалось сравнить хэши паролей.')
                    }
                }
            }
        });
    </script>
    
</body>
</html>